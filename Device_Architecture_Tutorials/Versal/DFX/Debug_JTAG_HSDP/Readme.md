<table>
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>Versal DFX Tutorial</h1>
   </td>
 </tr>
 <tr>
 <td align="center"><h1>Debug DFX Designs using JTAG or HSDP </h1>
 </td>
 </tr>
</table>

# Introduction

This design demonstrates the methodology to debug DFX designs in Versal using JTAG or HSDP. It covers the following:
- Debug Hub and ILA in the Static Region.
- Debug Hub and ILA in the reconfigurable module (rp1rm1)
- Debug Hub and VIO in the reconfigurable module (rp1rm2)
- Debug Hub and two ILAs in the reconfigurable module (rp1rm3) to demonstrate the automatic stitching of cores (ILAs in this case)  to the debug hub.
- Static-RM interface for the Debug Hub in RM is done using Inter NoC Interconnect (NoC INI). 
- Enabling HSDP in the CIPS for vck190
- Demonstrate using hardware manager to observe the waveforms generated by ILAs.

# Design Flow
- To run the design end to end:
`source run_all.tcl`

- This design flow uses a bottom-up approach where individual BDCs are created for rach reconfigurable module and top BD references these BDCs. You may also create these designs in the top-down apporach mentioned in "1RP_AXI_GPIO_in_RP_Interface_INI" tutorial. 

- Demonstrate that AXI Debug Hub stays as blackbox after synthesis and debug hub insertion flow in opt_design connects the cores and hubs. 

- Hardware Manager is used to observe the waveforms generated by ILAs in static and reconfigurable partition. 

## Bottom-Up IPI Design Creation Approach

The create_ipi.tcl creates individual BDs for each reconfigurable partition first, followed by a top BD creation that references the block design containers of individual reconfigurable partitions.

`source create_ipi.tcl`

### Top BD
- Once the IPI design creation is complete, you will observe design is categorized into 5 hierarchies: 1 static region and 1 reconfigurable partition.
-- Top BD with rp1rm1
  rp1rm1 has an up counter connected to ILA. This ILA will be stitched to Debug Hub in the rp1rm1 during opt_design of impl_1. 

<p align="center">
  <img src="./images/top_bd.png?raw=true" alt="top_bd"/>
</p>

### rp1rm2 BD

rp1rm2 has a down counter connected to VIO and ILA. ILA will be stitched to Debug Hub in rp1rm2 during opt_design of child_0_impl_1
<p align="center">
  <img src="./images/rp1rm2.png?raw=true" alt="rp1rm2"/>
</p>

### rp1rm3 BD

rp1rm3 has a down counter and up counter connected to two AXI GPIOs. Both counters are connected to seperate ILAs. Both the ILAs will be connected to the AXI Debug Hub in rp1rm3 during opt_design.
  
<p align="center">
  <img src="./images/rp1rm3.png?raw=true" alt="rp1rm3"/>
</p>

## Enable HSDP1 for CIPS
Follow the steps from [HSDP tutorial](https://xilinx.github.io/Embedded-Design-Tutorials/master/docs/Introduction/Versal-EDT/docs/6-system-design-example-HSDP.html
) to enable HSDP for high speed debug.

<p align="center">
  <img src="./images/hsdp.png?raw=true" alt="hsdp"/>
</p>

## Auto Insertion of Debug Hub during opt_design

- If you open the synthesized netlist, you will observe blackboxes for debug hub.

<p align="center">
  <img src="./images/synth_blackbox.png?raw=true" alt="synth_blackbox"/>
</p>

- The insertion of Debug Hub and stitching them to debug cores happen during opt_design of implementation phase. For implementation runs impl_1, child_0_impl_1 and child_1_impl_1, you will observe the following lines of code in the log file during opt_design. Please note that Debug Hub insertion for static region happens only during parent implementation and child implementation happens on the context of a locked static region from parent implementation . 

```
Phase 2 Generate And Synthesize Debug Cores
INFO: [Chipscope 16-329] Generating Script for core instance : design_1_i/rp1/axi_dbg_hub_0
INFO: [IP_Flow 19-3806] Processing IP xilinx.com:ip:axi_dbg_hub:2.0 for cell rp1rm1_inst_0_axi_dbg_hub_0_0_bb.
INFO: [Chipscope 16-329] Generating Script for core instance : design_1_i/static_region/axi_dbg_hub_0
INFO: [IP_Flow 19-3806] Processing IP xilinx.com:ip:axi_dbg_hub:2.0 for cell design_1_axi_dbg_hub_0_0_bb.
INFO: [Chipscope 16-324] Core: design_1_i/rp1/axi_dbg_hub_0 UUID: 2ba56efa-44aa-5cff-b4f7-161e160672ee
INFO: [Chipscope 16-324] Core: design_1_i/static_region/axi_dbg_hub_0 UUID: a46ff48e-6629-59e0-a9fe-ed94bf289898
Netlist sorting complete. Time (s): cpu = 00:00:00.05 ; elapsed = 00:00:00.06 . Memory (MB): peak = 5163.219 ; gain = 0.000 ; free physical = 39050 ; free virtual = 160892
Phase 2 Generate And Synthesize Debug Cores | Checksum: 23357821b

```

## Implementation

`source run_impl.tcl`

This file generates the targets for BDs, add the required constraints, define parent/child implementations using DFX wizard and run implementation through device image creation. We are also exporting XSAs from the implementation runs for future software application consumption.

## Hardware Validation
1. Download the full PDI from initial implementation and poll the GPIOs from static region and rp1rm1. GPIO from static region is connected to 32bit down counter and rp1rm1 is connected to a 32-bit up counter.

```
xsdb% targets
  1  Versal xcvc1902
     2  RPU (Reset)
        3  Cortex-R5 #0 (RPU PGE Reset)
        4  Cortex-R5 #1 (RPU PGE Reset)
     5  APU
        6  Cortex-A72 #0 (Power On Reset)
        7  Cortex-A72 #1 (Power On Reset)
     8  PPU
        9  MicroBlaze PPU (Sleeping)
    10  PSM
    11  PMC
    12  PL
xsdb% ta 5
xsdb% mrd -force 0x80210000
80210000:   8FE925FD

xsdb% mrd -force 0x80210000
80210000:   8560E3C5
```
2. Reading the GPIO in rp1rm1 to find the values counting-down.

```
xsdb% mrd -force 0x80220000
80220000:   54FFC5A1

xsdb% mrd -force 0x80220000
80220000:   5B4B7E91
```

3. Observe the output of counters in ILAs of static region and rp1rm1

- static region ILA

<p align="center">
  <img src="./images/static_region_down_counter_ila.png?raw=true" alt="static_region_down_counter_ila"/>
</p>

- rp1rm1 ILA

<p align="center">
  <img src="./images/rp1rm1_up_counter.png?raw=true" alt="rp1rm1_up_counter"/>
</p>

4. Enable Decouple Signal before downloading partial PDI for rp1rm2

```
xsdb% mwr -force 0x80200000 0x01
xsdb% mrd -force 0x80200000 
80200000:   00000001
```

5. Download partial PDI of rp1rm2 ( from child_0_impl_1) and release the Decouple signal.

```
xsdb% mwr -force 0x80200000 0x00
xsdb% mrd -force 0x80200000 
80200000:   00000000
```

6. Observe the Down counter in the rp1rm2

```
xsdb% mrd -force 0x80220000
80220000:   6B5A4A7D

xsdb% mrd -force 0x80220000
80220000:   60EF29C0

```
7. Observe the rp1rm2 Up counter using VIO in Vivado Hardware Manager.

<p align="center">
  <img src="./images/rp1rm2_vio.png?raw=true" alt="rp1rm2_vio"/>
</p>

8. Enable Decouple Signal before downloading partial PDI for rp1rm3

```
xsdb% mwr -force 0x80200000 0x01
xsdb% mrd -force 0x80200000 
80200000:   00000001
```
9. Once rp1rm3 partial PDI is downloaded, Disable the Decouple signal

```
xsdb% mwr -force 0x80200000 0x00
xsdb% mrd -force 0x80200000 
80200000:   00000000
```

10. Note that rp1rm3 has both up and down counter connected to two seperate ILAs.

```
xsdb% mrd -force 0x80220000
80220000:   24776086

xsdb% mrd -force 0x80220000
80220000:   36D42755

xsdb% mrd -force 0x80230000
80230000:   A8B2F57F

xsdb% mrd -force 0x80230000
80230000:   9B470AEA
```

11. Observe the outputs in ILAs.

- Up Counter in rp1rm3

<p align="center">
  <img src="./images/rp1rm3_up_counter.png?raw=true" alt="rp1rm3_up_counter"/>
</p>

- Down Counter in rp1rm3

<p align="center">
  <img src="./images/rp1rm3_down_counter.png?raw=true" alt="rp1rm3_down_counter"/>
</p>

